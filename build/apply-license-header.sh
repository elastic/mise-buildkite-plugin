#!/usr/bin/env bash

# Copyright 2025 Elasticsearch B.V.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Check that the Apache license is applied to all files in CHECK_PATH.
# If not set, it checks all files in the project.

set -eu

SCRIPT_DIR="$(dirname "$0")"
LICENSE_PATH="$SCRIPT_DIR/license-header.txt"

# shellcheck disable=2086
: "${CHECK_PATH:=$SCRIPT_DIR/..}" # defaults root project directory

# *.gen.go files are excluded because they are generated by oapi-codegen which doesn't
# produce files with license text yet
# shellcheck disable=SC2086
files=$(grep \
    --include=\*.bats \
    --include=\*.sh \
    --include=Makefile \
    --include=Makefile.base \
    --exclude-dir=.git \
    -L "Apache License, Version 2.0" \
    -r ${CHECK_PATH} || true)

hook_files=$(grep \
    -L "Apache License, Version 2.0" \
    -r ${CHECK_PATH}/hooks || true)

files="$files
$hook_files"

# applying header to files without it
for file in $files; do
    # echos are separated to avoid having -e modify $file contents
    # copy first to preserve file mode bits
    echo "applying license header to $file"
    case $file in
    *Makefile*)
        cp "$file" tmp_license &&
            echo -e "$(sed 's;^//;#;g' "$LICENSE_PATH")\n" >tmp_license &&
            cat "$file" >>tmp_license &&
            mv tmp_license "$file"
        ;;

    *.sh | *.bats | */hooks/*)
        cp "$file" tmp_license &&
            head -n 1 "$file" >tmp_license &&
            echo -e "\n$(sed 's;^//;#;g' "$LICENSE_PATH")" >>tmp_license &&
            tail -n +2 "$file" >>tmp_license &&
            mv tmp_license "$file"
        ;;
    esac
done

exit 0
